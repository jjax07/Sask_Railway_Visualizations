<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saskatchewan Railway Network Timeline</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000000;
            color: #eee;
        }
        .header {
            background: #1a1a1e;
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #0b6a41;
        }
        .header h1 {
            color: #ffffff;
            margin-bottom: 10px;
        }
        .header p {
            color: #9A9B9D;
            max-width: 800px;
            margin: 0 auto;
        }
        .nav {
            background: #252528;
            padding: 10px;
            text-align: center;
            position: relative;
        }
        .nav-dropdown {
            position: relative;
            display: inline-block;
        }
        .nav-btn {
            color: #f1c730;
            background: transparent;
            border: 1px solid #f1c730;
            padding: 8px 20px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .nav-btn:hover {
            background: #f1c730;
            color: #000;
        }
        .nav-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #252528;
            border: 1px solid #f1c730;
            border-radius: 5px;
            padding: 10px 0;
            min-width: 200px;
            z-index: 1000;
            margin-top: 5px;
        }
        .nav-menu.show {
            display: block;
        }
        .nav-menu a {
            display: block;
            color: #f1c730;
            text-decoration: none;
            padding: 8px 20px;
            transition: all 0.2s;
        }
        .nav-menu a:hover {
            background: #0b6a41;
            color: #fff;
        }
        .nav-menu a.current {
            color: #0b6a41;
            font-weight: bold;
        }
        .main-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 140px);
        }
        .map-container {
            flex: 1;
            display: flex;
        }
        #map {
            flex: 1;
            height: 100%;
        }
        .sidebar {
            width: 280px;
            background: #1a1a1e;
            padding: 15px;
            overflow-y: auto;
        }
        .controls {
            margin-bottom: 10px;
        }
        .year-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .year-row label {
            color: #f1c730;
            font-size: 13px;
            font-weight: bold;
        }
        .year-row input[type="range"] {
            flex: 1;
            margin: 0;
        }
        .year-display {
            font-size: 16px;
            font-weight: bold;
            color: #f1c730;
            min-width: 35px;
        }
        input[type="range"] {
            width: 100%;
            margin: 10px 0;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: #4D4E53;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            height: 6px;
            background: transparent;
            border-radius: 3px;
        }
        input[type="range"]::-moz-range-track {
            height: 6px;
            background: #4D4E53;
            border-radius: 3px;
        }
        input[type="range"]::-moz-range-progress {
            height: 6px;
            background: #f1c730;
            border-radius: 3px 0 0 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #ffffff;
            border-radius: 50%;
            margin-top: -5px;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #ffffff;
            border-radius: 50%;
            border: none;
            cursor: pointer;
        }
        .play-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .play-controls button {
            background: #0b6a41;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
        }
        .play-controls button:hover {
            background: #0d8550;
        }
        .legend {
            background: #252528;
            padding: 10px 12px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .legend h3 {
            color: #f1c730;
            margin-bottom: 8px;
            border-bottom: 1px solid #0b6a41;
            padding-bottom: 5px;
            font-size: 13px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            transition: background 0.2s;
            font-size: 12px;
        }
        .legend-item:hover {
            background: #000000;
        }
        .legend-item.inactive {
            opacity: 0.4;
        }
        .legend-circle {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid white;
        }
        .legend-count {
            margin-left: auto;
            background: #000000;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
        }
        .stats {
            background: #252528;
            padding: 10px 12px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .stats h3 {
            color: #f1c730;
            margin-bottom: 8px;
            border-bottom: 1px solid #0b6a41;
            padding-bottom: 5px;
            font-size: 13px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #000000;
            font-size: 12px;
        }
        .chart-container {
            height: 150px;
            background: #1a1a1e;
            padding: 10px 15px;
            border-top: 1px solid #252528;
        }
        .chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 110px;
            padding: 0 10px;
        }
        .chart-bar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            max-width: 50px;
        }
        .chart-bar {
            width: 30px;
            background: linear-gradient(to top, #0b6a41, #0d8550);
            border-radius: 3px 3px 0 0;
            transition: height 0.5s ease;
            position: relative;
        }
        .chart-bar.highlighted {
            background: linear-gradient(to top, #f1c730, #ffdd55);
        }
        .chart-bar .count {
            position: absolute;
            top: -16px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #fff;
        }
        .chart-label {
            margin-top: 3px;
            font-size: 10px;
            color: #9A9B9D;
        }
        .info-box {
            background: #252528;
            padding: 10px 12px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .info-box h3 {
            color: #f1c730;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .info-box p {
            font-size: 11px;
            color: #9A9B9D;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Saskatchewan Railway Network Timeline</h1>
        <p>Watch as different railway companies expanded across Saskatchewan from 1882 to 1920. Click on railway names in the legend to show/hide them.</p>
    </div>
    <div class="nav">
        <div class="nav-dropdown">
            <button class="nav-btn" id="navBtn">Other Visualizations â–¼</button>
            <div class="nav-menu" id="navMenu">
                <a href="index.html">Home</a>
                <a href="one_hour_map.html">Saskatoon Corridor</a>
                <a href="settlement_explorer.html">Settlement Explorer</a>
                <a href="railway_timeline.html" class="current">Railway Timeline</a>
                <a href="network_graph.html">Network Graph</a>
                <a href="isochrone.html">Travel Comparison</a>
                <a href="journey_times.html">Journey Times</a>
                <a href="travel_race.html">Time Simulation</a>
                <a href="time_distance.html">Time-Distance</a>
                <a href="transport_eras.html">Transport Eras</a>
            </div>
        </div>
    </div>
    <div class="main-container">
        <div class="map-container">
            <div id="map"></div>
            <div class="sidebar">
                <div class="controls">
                    <div class="year-row">
                        <label>Year:</label>
                        <span class="year-display" id="yearDisplay">1882</span>
                        <input type="range" id="yearSlider" min="1882" max="1920" step="1" value="1882">
                    </div>
                    <div class="play-controls">
                        <button id="playBtn">Play</button>
                        <button id="resetBtn">Reset</button>
                    </div>
                </div>

                <div class="legend">
                    <h3>Railway Companies</h3>
                    <div class="legend-item" data-railway="CPR">
                        <div class="legend-circle" style="background: #c75d38;"></div>
                        <span>CPR (Canadian Pacific)</span>
                        <span class="legend-count" id="count-CPR">0</span>
                    </div>
                    <div class="legend-item" data-railway="QLSRSC">
                        <div class="legend-circle" style="background: #0b6a41;"></div>
                        <span>QLSRSC</span>
                        <span class="legend-count" id="count-QLSRSC">0</span>
                    </div>
                    <div class="legend-item" data-railway="CNoR">
                        <div class="legend-circle" style="background: #f1c730;"></div>
                        <span>CNoR (Canadian Northern)</span>
                        <span class="legend-count" id="count-CNoR">0</span>
                    </div>
                    <div class="legend-item" data-railway="GTPR">
                        <div class="legend-circle" style="background: #6c5ce7;"></div>
                        <span>GTPR (Grand Trunk Pacific)</span>
                        <span class="legend-count" id="count-GTPR">0</span>
                    </div>
                    <div class="legend-item" data-railway="Other">
                        <div class="legend-circle" style="background: #9A9B9D;"></div>
                        <span>Other Railways</span>
                        <span class="legend-count" id="count-Other">0</span>
                    </div>
                </div>

                <div class="stats">
                    <h3>Statistics</h3>
                    <div class="stat-item">
                        <span>Total Settlements:</span>
                        <span id="totalSettlements">0</span>
                    </div>
                    <div class="stat-item">
                        <span>With Railway:</span>
                        <span id="withRailway">0</span>
                    </div>
                </div>

                <div class="info-box">
                    <h3>About the Railways</h3>
                    <p id="railwayInfo">
                        <b>CPR (1882+):</b> First transcontinental through southern SK.<br><br>
                        <b>QLSRSC (1889-90):</b> Regina to Prince Albert via Saskatoon.<br><br>
                        <b>CNoR (1899+):</b> Northerly competitor through Saskatoon.<br><br>
                        <b>GTPR (1905+):</b> Third transcontinental via Saskatoon.
                    </p>
                </div>
            </div>
        </div>
        <div class="chart-container">
            <div class="chart" id="yearChart"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Nav dropdown toggle
        document.getElementById('navBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('navMenu').classList.toggle('show');
        });
        document.addEventListener('click', function() {
            document.getElementById('navMenu').classList.remove('show');
        });

        let data = null;
        let map = null;
        let markers = {};
        let visibleRailways = {CPR: true, QLSRSC: true, CNoR: true, GTPR: true, Other: true};
        let isPlaying = false;
        let playInterval = null;

        const railwayColors = {
            CPR: '#c75d38',
            QLSRSC: '#0b6a41',
            CNoR: '#f1c730',
            GTPR: '#6c5ce7',
            Other: '#9A9B9D'
        };

        function initMap() {
            map = L.map('map').setView([52.0, -106.0], 6);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
        }

        async function loadData() {
            const response = await fetch('data/railway_timeline.json');
            data = await response.json();

            // Create markers for all settlements
            Object.keys(data).forEach(railway => {
                markers[railway] = [];

                data[railway].forEach(s => {
                    const marker = L.circleMarker([s.lat, s.lon], {
                        radius: 3,
                        fillColor: railwayColors[railway],
                        color: '#fff',
                        weight: 1,
                        opacity: 0,
                        fillOpacity: 0
                    }).addTo(map);

                    marker.bindPopup(`
                        <b>${s.name}</b><br>
                        Railway: ${railway}<br>
                        Year: ${s.year}
                    `);

                    markers[railway].push({marker, data: s});
                });
            });

            // Count total settlements
            const total = Object.values(data).reduce((sum, arr) => sum + arr.length, 0);
            document.getElementById('totalSettlements').textContent = total;

            // Build year chart
            buildYearChart();

            updateYear(1882);
        }

        function buildYearChart() {
            // Count settlements by year
            const yearCounts = {};
            for (let y = 1882; y <= 1920; y++) {
                yearCounts[y] = 0;
            }

            Object.values(data).flat().forEach(s => {
                if (s.year >= 1882 && s.year <= 1920) {
                    yearCounts[s.year]++;
                }
            });

            const maxCount = Math.max(...Object.values(yearCounts));
            const chartDiv = document.getElementById('yearChart');
            chartDiv.innerHTML = '';

            for (let y = 1882; y <= 1920; y++) {
                const count = yearCounts[y];
                const height = maxCount > 0 ? (count / maxCount) * 120 : 0;

                const container = document.createElement('div');
                container.className = 'chart-bar-container';
                container.innerHTML = `
                    <div class="chart-bar" data-year="${y}" style="height: ${height}px;">
                        ${count > 0 ? `<span class="count">${count}</span>` : ''}
                    </div>
                    <span class="chart-label">${y % 5 === 0 || y === 1882 ? y : ''}</span>
                `;
                chartDiv.appendChild(container);
            }
        }

        function updateSliderTrack(slider) {
            const min = parseInt(slider.min);
            const max = parseInt(slider.max);
            const val = parseInt(slider.value);
            const percent = ((val - min) / (max - min)) * 100;
            slider.style.background = `linear-gradient(to right, #f1c730 0%, #f1c730 ${percent}%, #4D4E53 ${percent}%, #4D4E53 100%)`;
        }

        function updateYear(year) {
            document.getElementById('yearDisplay').textContent = year;
            const slider = document.getElementById('yearSlider');
            slider.value = year;
            updateSliderTrack(slider);

            const counts = {CPR: 0, QLSRSC: 0, CNoR: 0, GTPR: 0, Other: 0};
            let totalWithRailway = 0;

            Object.keys(markers).forEach(railway => {
                markers[railway].forEach(m => {
                    const isVisible = m.data.year <= year && visibleRailways[railway];
                    if (m.data.year <= year) {
                        counts[railway]++;
                        totalWithRailway++;
                    }

                    m.marker.setStyle({
                        opacity: isVisible ? 1 : 0,
                        fillOpacity: isVisible ? 0.8 : 0
                    });
                });
            });

            // Update counts
            Object.keys(counts).forEach(railway => {
                document.getElementById(`count-${railway}`).textContent = counts[railway];
            });
            document.getElementById('withRailway').textContent = totalWithRailway;

            // Highlight current year in chart
            document.querySelectorAll('.chart-bar').forEach(bar => {
                if (parseInt(bar.dataset.year) === year) {
                    bar.classList.add('highlighted');
                } else {
                    bar.classList.remove('highlighted');
                }
            });
        }

        function toggleRailway(railway) {
            visibleRailways[railway] = !visibleRailways[railway];
            const legendItem = document.querySelector(`.legend-item[data-railway="${railway}"]`);
            legendItem.classList.toggle('inactive', !visibleRailways[railway]);
            updateYear(parseInt(document.getElementById('yearSlider').value));
        }

        function togglePlay() {
            if (isPlaying) {
                clearInterval(playInterval);
                document.getElementById('playBtn').textContent = 'Play';
                isPlaying = false;
            } else {
                isPlaying = true;
                document.getElementById('playBtn').textContent = 'Pause';
                let year = parseInt(document.getElementById('yearSlider').value);

                playInterval = setInterval(() => {
                    year++;
                    if (year > 1920) {
                        clearInterval(playInterval);
                        document.getElementById('playBtn').textContent = 'Play';
                        isPlaying = false;
                        return;
                    }
                    updateYear(year);
                }, 300);
            }
        }

        function reset() {
            if (isPlaying) togglePlay();
            updateYear(1882);
        }

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadData();

            document.getElementById('yearSlider').addEventListener('input', (e) => {
                updateYear(parseInt(e.target.value));
            });

            document.getElementById('playBtn').addEventListener('click', togglePlay);
            document.getElementById('resetBtn').addEventListener('click', reset);

            document.querySelectorAll('.legend-item').forEach(item => {
                item.addEventListener('click', () => {
                    toggleRailway(item.dataset.railway);
                });
            });
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time-Distance Map - Saskatchewan Railway Visualizations</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000000;
            color: #eee;
        }
        .header {
            background: #1a1a1e;
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #0b6a41;
        }
        .header h1 { color: #ffffff; margin-bottom: 10px; }
        .header p { color: #9A9B9D; max-width: 800px; margin: 0 auto; }
        .nav {
            background: #252528;
            padding: 10px;
            text-align: center;
            position: relative;
        }
        .nav-dropdown {
            position: relative;
            display: inline-block;
        }
        .nav-btn {
            color: #f1c730;
            background: transparent;
            border: 1px solid #f1c730;
            padding: 8px 20px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .nav-btn:hover {
            background: #f1c730;
            color: #000;
        }
        .nav-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #252528;
            border: 1px solid #f1c730;
            border-radius: 5px;
            padding: 10px 0;
            min-width: 200px;
            z-index: 1000;
            margin-top: 5px;
        }
        .nav-menu.show {
            display: block;
        }
        .nav-menu a {
            display: block;
            color: #f1c730;
            text-decoration: none;
            padding: 8px 20px;
            transition: all 0.2s;
        }
        .nav-menu a:hover {
            background: #0b6a41;
            color: #fff;
        }
        .nav-menu a.current {
            color: #0b6a41;
            font-weight: bold;
        }
        .container {
            display: flex;
            height: calc(100vh - 160px);
        }
        .view-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        #map {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }
        #overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 2;
            pointer-events: none;
        }
        .sidebar {
            width: 280px;
            background: #1a1a1e;
            padding: 15px;
            overflow-y: auto;
        }
        .control-group {
            background: #252528;
            padding: 10px 12px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .control-group h3 {
            color: #f1c730;
            margin-bottom: 8px;
            font-size: 13px;
            border-bottom: 1px solid #0b6a41;
            padding-bottom: 5px;
        }
        .mode-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        .mode-btn {
            padding: 8px 6px;
            background: #000000;
            color: #9A9B9D;
            border: 2px solid #252528;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            text-align: center;
            transition: all 0.3s;
        }
        .mode-btn:hover {
            color: #eee;
        }
        .mode-btn[data-mode="geographic"] { border-color: #252528; }
        .mode-btn[data-mode="geographic"]:hover { border-color: #4ecca3; }
        .mode-btn[data-mode="geographic"].active { border-color: #4ecca3; color: #4ecca3; background: rgba(78, 204, 163, 0.1); }
        .mode-btn[data-mode="walking"] { border-color: #252528; }
        .mode-btn[data-mode="walking"]:hover { border-color: #ff6b6b; }
        .mode-btn[data-mode="walking"].active { border-color: #ff6b6b; color: #ff6b6b; background: rgba(255, 107, 107, 0.1); }
        .mode-btn[data-mode="horse"] { border-color: #252528; }
        .mode-btn[data-mode="horse"]:hover { border-color: #e09530; }
        .mode-btn[data-mode="horse"].active { border-color: #e09530; color: #e09530; background: rgba(224, 149, 48, 0.1); }
        .mode-btn[data-mode="railway"] { border-color: #252528; }
        .mode-btn[data-mode="railway"]:hover { border-color: #4ecca3; }
        .mode-btn[data-mode="railway"].active { border-color: #4ecca3; color: #4ecca3; background: rgba(78, 204, 163, 0.1); }
        .year-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .year-row label {
            color: #f1c730;
            font-size: 13px;
            font-weight: bold;
        }
        .year-row input[type="range"] {
            flex: 1;
            margin: 0;
        }
        .year-display {
            font-size: 16px;
            font-weight: bold;
            color: #f1c730;
            min-width: 35px;
        }
        input[type="range"] {
            width: 100%;
            margin: 10px 0;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: #4D4E53;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            height: 6px;
            background: transparent;
            border-radius: 3px;
        }
        input[type="range"]::-moz-range-track {
            height: 6px;
            background: #4D4E53;
            border-radius: 3px;
        }
        input[type="range"]::-moz-range-progress {
            height: 6px;
            background: #f1c730;
            border-radius: 3px 0 0 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #ffffff;
            border-radius: 50%;
            margin-top: -5px;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #ffffff;
            border-radius: 50%;
            border: none;
            cursor: pointer;
        }
        .play-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .play-controls button {
            background: #0b6a41;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
        }
        .play-controls button:hover {
            background: #0d8550;
        }
        .stats-box {
            background: #000000;
            padding: 10px 12px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #252528;
            font-size: 12px;
        }
        .stat-value { color: #f1c730; font-weight: bold; }
        .legend {
            margin-top: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 11px;
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }
        .legend-line {
            width: 20px;
            height: 2px;
            margin-right: 8px;
            flex-shrink: 0;
        }
        .explanation {
            margin-top: 10px;
            padding: 10px;
            background: #252528;
            border-left: 3px solid #0b6a41;
            border-radius: 3px;
            font-size: 11px;
            color: #9A9B9D;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Time-Distance Map</h1>
        <p>Watch settlements reposition based on travel time. Railways collapse connected settlements together while isolated ones stay far apart.</p>
    </div>
    <div class="nav">
        <div class="nav-dropdown">
            <button class="nav-btn" id="navBtn">Other Visualizations â–¼</button>
            <div class="nav-menu" id="navMenu">
                <a href="index.html">Home</a>
                <a href="one_hour_map.html">Saskatoon Corridor</a>
                <a href="settlement_explorer.html">Settlement Explorer</a>
                <a href="railway_timeline.html">Railway Timeline</a>
                <a href="network_graph.html">Network Graph</a>
                <a href="isochrone.html">Travel Comparison</a>
                <a href="journey_times.html">Journey Times</a>
                <a href="travel_race.html">Time Simulation</a>
                <a href="time_distance.html" class="current">Time-Distance</a>
                <a href="transport_eras.html">Transport Eras</a>
                <a href="railway_temporal_network.html">Temporal Network</a>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="view-container" id="viewContainer">
            <div id="map"></div>
            <canvas id="overlay"></canvas>
        </div>
        <div class="sidebar">
            <div class="control-group">
                <h3>Transport Mode</h3>
                <div class="mode-grid">
                    <button class="mode-btn active" data-mode="geographic">Geographic</button>
                    <button class="mode-btn" data-mode="walking">Walking (5 km/h)</button>
                    <button class="mode-btn" data-mode="horse">Horse & Cart (10)</button>
                    <button class="mode-btn" data-mode="railway">Railway (40 km/h)</button>
                </div>
            </div>
            <div class="control-group" id="yearControls" style="display:none;">
                <h3>Year</h3>
                <div class="year-row">
                    <label>Year</label>
                    <input type="range" id="yearSlider" min="1880" max="1920" value="1880">
                    <span class="year-display" id="yearDisplay">1880</span>
                </div>
                <div class="play-controls">
                    <button id="playBtn">Play</button>
                    <button id="resetBtn">Reset</button>
                </div>
            </div>
            <div class="control-group">
                <h3>Statistics</h3>
                <div class="stats-box">
                    <div class="stat-row"><span>Total settlements</span><span class="stat-value" id="statTotal">429</span></div>
                    <div class="stat-row"><span>Rail-connected</span><span class="stat-value" id="statRail">0</span></div>
                    <div class="stat-row"><span>Rail pairs</span><span class="stat-value" id="statPairs">0</span></div>
                    <div class="stat-row"><span>Avg displacement</span><span class="stat-value" id="statDisplacement">0 px</span></div>
                </div>
            </div>
            <div class="control-group">
                <h3>Legend</h3>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-dot" id="legendDotRail" style="background: #4ecca3;"></div>
                        <span>Rail-connected settlement</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #666;"></div>
                        <span>Isolated settlement</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line" id="legendLineRail" style="background: #4ecca3;"></div>
                        <span>Rail connection</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line" style="background: #444;"></div>
                        <span>Walking connection</span>
                    </div>
                </div>
            </div>
            <div class="explanation">
                <strong>How it works:</strong> In geographic mode, settlements appear at their real map positions. Walking and horse modes expand the map to show travel time as distance. Railway mode keeps the geographic layout but contracts rail-connected settlements toward each other along visible railway lines, while off-rail settlements stay in place. Lines are colored by railway company.
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    // Nav dropdown toggle
    document.getElementById('navBtn').addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('navMenu').classList.toggle('show');
    });
    document.addEventListener('click', function() {
        document.getElementById('navMenu').classList.remove('show');
    });

    (function() {
        // State
        let settlements = [];
        let connections = [];
        let settlementsByName = {};
        let currentMode = 'geographic';
        let currentYear = 1880;
        let mapOpacity = 1.0;
        let targetMapOpacity = 1.0;
        let railwayLayoutDirty = true;
        let railwayPositions = null;
        let playInterval = null;
        let hoveredSettlement = null;

        // DOM
        const viewContainer = document.getElementById('viewContainer');
        const canvas = document.getElementById('overlay');
        const ctx = canvas.getContext('2d');
        const yearSlider = document.getElementById('yearSlider');
        const yearDisplay = document.getElementById('yearDisplay');
        const playBtn = document.getElementById('playBtn');
        const resetBtn = document.getElementById('resetBtn');

        // Map init
        const map = L.map('map', {
            center: [51.25, -105.5],
            zoom: 7,
            zoomControl: false,
            dragging: false,
            scrollWheelZoom: false,
            doubleClickZoom: false,
            touchZoom: false,
            boxZoom: false,
            keyboard: false,
            attributionControl: false
        });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19
        }).addTo(map);

        // Resize canvas
        function resizeCanvas() {
            const rect = viewContainer.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
        }
        window.addEventListener('resize', () => {
            resizeCanvas();
            map.invalidateSize();
            recomputeGeoPositions();
        });

        // Load data
        fetch('data/settlement_connections.json')
            .then(r => r.json())
            .then(data => {
                processData(data);
                resizeCanvas();
                recomputeGeoPositions();
                setMode('geographic');
                requestAnimationFrame(animate);
            });

        function processData(data) {
            const settData = data.settlements;
            const connData = data.connections;

            // Build settlements array
            const names = Object.keys(settData);
            names.forEach(name => {
                const s = settData[name];
                const obj = {
                    name: name,
                    lat: s.lat,
                    lon: s.lon,
                    railwayArrives: s.railway_arrives || null,
                    firstRailway: s.first_railway || null,
                    hasRailway: false,
                    // Current animated position
                    x: 0, y: 0,
                    // Target positions per mode
                    geoX: 0, geoY: 0,
                    walkX: 0, walkY: 0,
                    horseX: 0, horseY: 0,
                    railX: 0, railY: 0,
                    // Animation target
                    targetX: 0, targetY: 0
                };
                settlements.push(obj);
                settlementsByName[name] = obj;
            });

            // Build deduplicated connections
            const seen = new Set();
            for (const fromName of Object.keys(connData)) {
                const entries = connData[fromName];
                for (const entry of entries) {
                    const toName = entry.to;
                    const key = [fromName, toName].sort().join('|');
                    if (seen.has(key)) continue;
                    seen.add(key);
                    const fromS = settlementsByName[fromName];
                    const toS = settlementsByName[toName];
                    if (!fromS || !toS) continue;
                    connections.push({
                        from: fromS,
                        to: toS,
                        distance_km: entry.distance_km,
                        railway_distance_km: entry.railway_distance_km || null,
                        shared_railway: entry.shared_railway || null,
                        connected_year: entry.connected_year || null,
                        hasRail: false
                    });
                }
            }
            updateRailFlags();
        }

        function updateRailFlags() {
            settlements.forEach(s => {
                s.hasRailway = s.railwayArrives !== null && s.railwayArrives <= currentYear;
            });
            connections.forEach(c => {
                c.hasRail = c.shared_railway !== null && c.connected_year !== null && c.connected_year <= currentYear;
            });
        }

        function recomputeGeoPositions() {
            settlements.forEach(s => {
                const pt = map.latLngToContainerPoint([s.lat, s.lon]);
                s.geoX = pt.x;
                s.geoY = pt.y;
            });
            computeWalkingPositions();
            computeHorsePositions();
            railwayLayoutDirty = true;
        }

        function computeWalkingPositions() {
            // Radial 1.2x expansion from centroid
            const cx = settlements.reduce((a, s) => a + s.geoX, 0) / settlements.length;
            const cy = settlements.reduce((a, s) => a + s.geoY, 0) / settlements.length;
            settlements.forEach(s => {
                const dx = s.geoX - cx;
                const dy = s.geoY - cy;
                s.walkX = cx + dx * 1.2;
                s.walkY = cy + dy * 1.2;
            });
        }

        function computeHorsePositions() {
            // Radial 1.0x (reference, same as geographic relative layout)
            const cx = settlements.reduce((a, s) => a + s.geoX, 0) / settlements.length;
            const cy = settlements.reduce((a, s) => a + s.geoY, 0) / settlements.length;
            settlements.forEach(s => {
                const dx = s.geoX - cx;
                const dy = s.geoY - cy;
                s.horseX = cx + dx * 1.0;
                s.horseY = cy + dy * 1.0;
            });
        }

        function computeRailwayPositions() {
            if (!railwayLayoutDirty && railwayPositions) return;

            // Initialize all positions from geographic
            const pos = settlements.map(s => ({ x: s.geoX, y: s.geoY }));

            // Build index for fast lookups
            const idxMap = new Map();
            settlements.forEach((s, i) => idxMap.set(s, i));

            // Identify rail-connected settlements (only those move)
            const railSettlementSet = new Set();
            const railConns = [];
            for (const conn of connections) {
                if (conn.hasRail && conn.railway_distance_km) {
                    const iFrom = idxMap.get(conn.from);
                    const iTo = idxMap.get(conn.to);
                    railSettlementSet.add(iFrom);
                    railSettlementSet.add(iTo);
                    // Compression ratio: railway contracts distances
                    const ratio = conn.railway_distance_km / (8 * conn.distance_km);
                    railConns.push({ iFrom, iTo, ratio });
                }
            }

            // Off-rail settlements stay at geographic positions (never moved)
            // Only rail-connected settlements participate in stress minimization

            const iterations = 300;
            for (let iter = 0; iter < iterations; iter++) {
                const t = iter / iterations;
                const stepSize = 0.4 * (1 - t);

                // Stress minimization: pull rail pairs toward compressed distances
                for (const rc of railConns) {
                    const dx = pos[rc.iTo].x - pos[rc.iFrom].x;
                    const dy = pos[rc.iTo].y - pos[rc.iFrom].y;
                    const currentDist = Math.sqrt(dx * dx + dy * dy) || 0.001;

                    // Target distance = current geo distance * compression ratio
                    const geoDx = settlements[rc.iTo].geoX - settlements[rc.iFrom].geoX;
                    const geoDy = settlements[rc.iTo].geoY - settlements[rc.iFrom].geoY;
                    const geoDist = Math.sqrt(geoDx * geoDx + geoDy * geoDy) || 0.001;
                    const targetDist = geoDist * rc.ratio;

                    const diff = (currentDist - targetDist) / currentDist;
                    const moveX = dx * diff * stepSize * 0.5;
                    const moveY = dy * diff * stepSize * 0.5;

                    pos[rc.iFrom].x += moveX;
                    pos[rc.iFrom].y += moveY;
                    pos[rc.iTo].x -= moveX;
                    pos[rc.iTo].y -= moveY;
                }

                // Weak geo-anchoring force to preserve orientation
                for (const idx of railSettlementSet) {
                    const s = settlements[idx];
                    pos[idx].x += (s.geoX - pos[idx].x) * 0.02;
                    pos[idx].y += (s.geoY - pos[idx].y) * 0.02;
                }
            }

            // Store results
            railwayPositions = pos;
            railwayLayoutDirty = false;
        }

        // Build index for fast lookups
        let settlementIndices = null;
        function buildIndices() {
            settlementIndices = new Map();
            settlements.forEach((s, i) => settlementIndices.set(s, i));
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.mode === mode);
            });

            if (mode === 'geographic') {
                targetMapOpacity = 1.0;
                settlements.forEach(s => { s.targetX = s.geoX; s.targetY = s.geoY; });
            } else if (mode === 'walking') {
                targetMapOpacity = 0.0;
                settlements.forEach(s => { s.targetX = s.walkX; s.targetY = s.walkY; });
            } else if (mode === 'horse') {
                targetMapOpacity = 0.0;
                settlements.forEach(s => { s.targetX = s.horseX; s.targetY = s.horseY; });
            } else if (mode === 'railway') {
                targetMapOpacity = 0.25;
                computeRailwayPositions();
                settlements.forEach((s, i) => {
                    s.targetX = railwayPositions[i].x;
                    s.targetY = railwayPositions[i].y;
                });
            }
            // Show year controls only in railway mode
            const yearControls = document.getElementById('yearControls');
            yearControls.style.display = mode === 'railway' ? '' : 'none';
            if (mode === 'railway') {
                // Force slider thumb to render at correct position after unhiding
                yearSlider.value = currentYear;
            }
            updateStats();
            // Update legend colors
            const lc = currentMode === 'walking' ? '#ff6b6b' :
                        currentMode === 'horse' ? '#e09530' : '#4ecca3';
            document.getElementById('legendDotRail').style.background = lc;
            document.getElementById('legendLineRail').style.background = lc;
        }

        // Mode buttons
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => setMode(btn.dataset.mode));
        });

        // Year controls
        yearSlider.addEventListener('input', () => {
            currentYear = parseInt(yearSlider.value);
            yearDisplay.textContent = currentYear;
            updateRailFlags();
            railwayLayoutDirty = true;
            if (currentMode === 'railway') {
                computeRailwayPositions();
                settlements.forEach((s, i) => {
                    s.targetX = railwayPositions[i].x;
                    s.targetY = railwayPositions[i].y;
                });
            }
            updateStats();
        });

        playBtn.addEventListener('click', () => {
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
                playBtn.textContent = 'Play';
                return;
            }
            playBtn.textContent = 'Pause';
            playInterval = setInterval(() => {
                let year = parseInt(yearSlider.value);
                if (year >= 1920) {
                    clearInterval(playInterval);
                    playInterval = null;
                    playBtn.textContent = 'Play';
                    return;
                }
                yearSlider.value = year + 1;
                yearSlider.dispatchEvent(new Event('input'));
            }, 500);
        });

        resetBtn.addEventListener('click', () => {
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
                playBtn.textContent = 'Play';
            }
            yearSlider.value = 1880;
            yearSlider.dispatchEvent(new Event('input'));
        });

        // Stats
        function updateStats() {
            const railCount = settlements.filter(s => s.hasRailway).length;
            const railPairs = connections.filter(c => c.hasRail).length;
            document.getElementById('statTotal').textContent = settlements.length;
            document.getElementById('statRail').textContent = railCount;
            document.getElementById('statPairs').textContent = railPairs;
        }

        // Hover
        viewContainer.addEventListener('mousemove', (e) => {
            const rect = viewContainer.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;
            let closest = null;
            let closestDist = 20;
            for (const s of settlements) {
                const d = Math.sqrt((s.x - mx) ** 2 + (s.y - my) ** 2);
                if (d < closestDist) {
                    closestDist = d;
                    closest = s;
                }
            }
            hoveredSettlement = closest;
        });
        viewContainer.addEventListener('mouseleave', () => {
            hoveredSettlement = null;
        });

        // Animation
        function animate() {
            // LERP positions
            let totalDisp = 0;
            settlements.forEach(s => {
                s.x += (s.targetX - s.x) * 0.04;
                s.y += (s.targetY - s.y) * 0.04;
                totalDisp += Math.sqrt((s.x - s.geoX) ** 2 + (s.y - s.geoY) ** 2);
            });
            const avgDisp = settlements.length > 0 ? (totalDisp / settlements.length) : 0;
            document.getElementById('statDisplacement').textContent = Math.round(avgDisp) + ' px';

            // LERP map opacity
            mapOpacity += (targetMapOpacity - mapOpacity) * 0.04;
            document.getElementById('map').style.opacity = mapOpacity;

            // Draw
            draw();
            requestAnimationFrame(animate);
        }

        function draw() {
            const w = canvas.width;
            const h = canvas.height;
            ctx.clearRect(0, 0, w, h);

            // Dark background (fades in as map fades out)
            ctx.fillStyle = `rgba(0, 0, 0, ${1 - mapOpacity})`;
            ctx.fillRect(0, 0, w, h);

            // Railway company colors
            const railwayColors = {
                'CPR': '#c75d38',
                'CNoR': '#f1c730',
                'GTPR': '#6c5ce7',
                'QLSRSC': '#0b6a41',
                'Interchange': '#ffffff',
                'Other': '#888'
            };

            // Draw connection lines
            const isRailMode = currentMode === 'railway';
            const lineColor = currentMode === 'walking' ? 'rgba(255, 107, 107, 0.15)' :
                              currentMode === 'horse' ? 'rgba(224, 149, 48, 0.15)' :
                              'rgba(78, 204, 163, 0.15)';
            for (const c of connections) {
                if (c.hasRail) {
                    if (isRailMode) {
                        const rc = railwayColors[c.shared_railway] || railwayColors['Other'];
                        ctx.strokeStyle = rc;
                        ctx.lineWidth = 2.5;
                        ctx.globalAlpha = 0.7;
                    } else {
                        ctx.strokeStyle = lineColor;
                        ctx.lineWidth = 1;
                        ctx.globalAlpha = 1.0;
                    }
                } else {
                    if (isRailMode) continue; // Hide non-rail connections in railway mode
                    ctx.strokeStyle = 'rgba(100, 100, 100, 0.06)';
                    ctx.lineWidth = 0.5;
                    ctx.globalAlpha = 1.0;
                }
                ctx.beginPath();
                ctx.moveTo(c.from.x, c.from.y);
                ctx.lineTo(c.to.x, c.to.y);
                ctx.stroke();
            }
            ctx.globalAlpha = 1.0;

            // Draw settlement dots
            const modeColor = currentMode === 'walking' ? '#ff6b6b' :
                              currentMode === 'horse' ? '#e09530' : '#4ecca3';
            for (const s of settlements) {
                if (isRailMode) {
                    if (s.hasRailway) {
                        ctx.fillStyle = modeColor;
                        const r = 3.5;
                        ctx.beginPath();
                        ctx.arc(s.x, s.y, r, 0, Math.PI * 2);
                        ctx.fill();
                    } else {
                        ctx.fillStyle = 'rgba(100, 100, 100, 0.25)';
                        const r = 1.5;
                        ctx.beginPath();
                        ctx.arc(s.x, s.y, r, 0, Math.PI * 2);
                        ctx.fill();
                    }
                } else if (currentMode === 'geographic') {
                    const r = s.hasRailway ? 3 : 2;
                    ctx.fillStyle = s.hasRailway ? modeColor : '#666';
                    ctx.beginPath();
                    ctx.arc(s.x, s.y, r, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    // Walking / horse: all settlements shown in mode color
                    ctx.fillStyle = modeColor;
                    ctx.beginPath();
                    ctx.arc(s.x, s.y, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            // Scale bar
            drawScaleBar();

            // Hover tooltip
            if (hoveredSettlement) {
                drawTooltip(hoveredSettlement);
            }
        }

        function drawScaleBar() {
            if (currentMode === 'geographic') return;

            const x = 80;
            const y = canvas.height - 60;

            if (currentMode === 'railway') {
                // Show contraction annotation with visual comparison
                const fullLen = 80;
                const contractedLen = fullLen / 8;

                // Geographic distance line (dimmed)
                ctx.strokeStyle = 'rgba(150, 150, 150, 0.4)';
                ctx.lineWidth = 1;
                ctx.setLineDash([4, 3]);
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x + fullLen, y);
                ctx.stroke();
                ctx.setLineDash([]);

                // Contracted railway distance line (bright)
                ctx.strokeStyle = '#4ecca3';
                ctx.lineWidth = 2.5;
                ctx.beginPath();
                ctx.moveTo(x, y + 12);
                ctx.lineTo(x + contractedLen, y + 12);
                ctx.stroke();

                // Dots at endpoints
                ctx.fillStyle = 'rgba(150, 150, 150, 0.4)';
                ctx.beginPath();
                ctx.arc(x, y, 2.5, 0, Math.PI * 2);
                ctx.arc(x + fullLen, y, 2.5, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#4ecca3';
                ctx.beginPath();
                ctx.arc(x, y + 12, 2.5, 0, Math.PI * 2);
                ctx.arc(x + contractedLen, y + 12, 2.5, 0, Math.PI * 2);
                ctx.fill();

                // Labels
                ctx.fillStyle = 'rgba(150, 150, 150, 0.5)';
                ctx.font = '10px Segoe UI, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText('geographic', x + fullLen + 6, y + 4);
                ctx.fillStyle = '#4ecca3';
                ctx.fillText('by rail (8\u00d7 closer)', x + contractedLen + 6, y + 16);

                ctx.fillStyle = '#9A9B9D';
                ctx.font = '10px Segoe UI, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText('40 km/h rail vs 5 km/h walking', x, y - 10);
                return;
            }

            const speed = currentMode === 'walking' ? 5 : 10;
            const oneHourKm = speed;
            // Approximate scale: find average km-per-pixel from geo positions
            let totalGeoPixDist = 0;
            let totalKmDist = 0;
            let count = 0;
            for (let i = 0; i < Math.min(connections.length, 200); i++) {
                const c = connections[i];
                const geoDx = c.from.geoX - c.to.geoX;
                const geoDy = c.from.geoY - c.to.geoY;
                const geoPx = Math.sqrt(geoDx * geoDx + geoDy * geoDy);
                if (geoPx > 1) {
                    totalGeoPixDist += geoPx;
                    totalKmDist += c.distance_km;
                    count++;
                }
            }
            if (count === 0) return;
            const kmPerPx = totalKmDist / totalGeoPixDist;

            let barPx;
            if (currentMode === 'walking') {
                barPx = oneHourKm / kmPerPx * 1.2; // walking scale factor
            } else {
                barPx = oneHourKm / kmPerPx * 1.0;
            }

            const scaleColor = currentMode === 'walking' ? '#ff6b6b' : '#e09530';
            ctx.strokeStyle = scaleColor;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x + barPx, y);
            ctx.stroke();
            // End caps
            ctx.beginPath();
            ctx.moveTo(x, y - 5);
            ctx.lineTo(x, y + 5);
            ctx.moveTo(x + barPx, y - 5);
            ctx.lineTo(x + barPx, y + 5);
            ctx.stroke();

            ctx.fillStyle = scaleColor;
            ctx.font = '11px Segoe UI, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('1 hour at ' + speed + ' km/h', x + barPx / 2, y - 10);
        }

        function drawTooltip(s) {
            const text = s.name;
            const railInfo = s.hasRailway ?
                'Railway: ' + s.firstRailway + ' (' + s.railwayArrives + ')' :
                'No railway by ' + currentYear;

            ctx.font = 'bold 12px Segoe UI, sans-serif';
            const w1 = ctx.measureText(text).width;
            ctx.font = '10px Segoe UI, sans-serif';
            const w2 = ctx.measureText(railInfo).width;
            const boxW = Math.max(w1, w2) + 16;
            const boxH = 38;
            const bx = s.x + 12;
            const by = s.y - boxH - 5;

            ctx.fillStyle = 'rgba(37, 37, 40, 0.95)';
            ctx.strokeStyle = '#f1c730';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.roundRect(bx, by, boxW, boxH, 4);
            ctx.fill();
            ctx.stroke();

            ctx.fillStyle = '#eee';
            ctx.font = 'bold 12px Segoe UI, sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(text, bx + 8, by + 15);
            ctx.fillStyle = s.hasRailway ? '#4ecca3' : '#888';
            ctx.font = '10px Segoe UI, sans-serif';
            ctx.fillText(railInfo, bx + 8, by + 30);
        }
    })();
    </script>
</body>
</html>

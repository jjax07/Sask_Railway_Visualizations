<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saskatchewan Railways - Temporal Network</title>
    <script src="https://unpkg.com/vis-network@9.1.2/standalone/umd/vis-network.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            height: 100vh;
            color: #eee;
            overflow: hidden;
        }
        .header {
            padding: 15px 30px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 1.5rem; }
        .header .subtitle { color: #888; font-size: 0.9rem; }
        .header-links { display: flex; gap: 20px; }
        .header-links a { color: #7eb8da; text-decoration: none; font-size: 0.9rem; }
        .header-links a:hover { color: #fff; }
        .main-container {
            display: flex;
            height: calc(100vh - 70px);
            overflow: hidden;
        }
        .network-panel {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        #network { width: 100%; height: 100%; }
        .sidebar {
            width: 300px;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar h3 {
            color: #aaa;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.8rem;
        }
        .legend-dot { width: 14px; height: 14px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }
        .legend-diamond {
            width: 10px; height: 10px;
            transform: rotate(45deg);
            margin-right: 10px;
            flex-shrink: 0;
        }
        .legend-box {
            width: 20px; height: 12px;
            margin-right: 10px;
            border-radius: 2px;
            flex-shrink: 0;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.8rem;
        }
        .stat-item .label { color: #888; }
        .stat-item .value { color: #fff; font-weight: 500; }
        .control-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 5px;
            color: #ccc;
            font-size: 0.85rem;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
        }
        .control-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .control-btn.active { background: rgba(78,121,167,0.3); border-color: #4E79A7; }
        .details-panel {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .details-content { font-size: 0.85rem; color: #bbb; line-height: 1.5; }
        .instructions {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 5px;
            font-size: 0.75rem;
            color: #888;
            line-height: 1.5;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>Saskatchewan Railways: Temporal Network</h1>
            <p class="subtitle">Settlements anchored by year, railway companies pulled by construction activity</p>
        </div>
        <div class="header-links">
            <a href="railway_timeline.html">Map Timeline</a>
            <a href="network_graph.html">Network Graph</a>
            <a href="index.html">Back to Index</a>
        </div>
    </div>
    <div class="main-container">
        <div class="network-panel">
            <div id="network"></div>
            <div class="loading" id="loading">Loading railway data...</div>
        </div>
        <div class="sidebar">
            <h3>Node Types</h3>
            <div class="legend-item"><div class="legend-box" style="background: #2d3748; border: 1px solid #4a5568;"></div><span>Years (fixed timeline)</span></div>
            <div class="legend-item"><div class="legend-dot" style="background: #c75d38;"></div><span>CPR (Canadian Pacific)</span></div>
            <div class="legend-item"><div class="legend-dot" style="background: #0b6a41;"></div><span>QLSRSC (Qu'Appelle, Long Lake)</span></div>
            <div class="legend-item"><div class="legend-dot" style="background: #f1c730;"></div><span>CNoR (Canadian Northern)</span></div>
            <div class="legend-item"><div class="legend-dot" style="background: #6c5ce7;"></div><span>GTPR (Grand Trunk Pacific)</span></div>
            <div class="legend-item"><div class="legend-dot" style="background: #9A9B9D;"></div><span>Other Railways</span></div>

            <h3 style="margin-top: 15px;">Settlement Nodes</h3>
            <div class="legend-item"><div class="legend-diamond" style="background: #c75d38;"></div><span>CPR settlement</span></div>
            <div class="legend-item"><div class="legend-diamond" style="background: #0b6a41;"></div><span>QLSRSC settlement</span></div>
            <div class="legend-item"><div class="legend-diamond" style="background: #f1c730;"></div><span>CNoR settlement</span></div>
            <div class="legend-item"><div class="legend-diamond" style="background: #6c5ce7;"></div><span>GTPR settlement</span></div>
            <div class="legend-item"><div class="legend-diamond" style="background: #9A9B9D;"></div><span>Other settlement</span></div>

            <h3 style="margin-top: 15px;">Statistics</h3>
            <div class="stat-item"><span class="label">Years Covered</span><span class="value" id="statYears">-</span></div>
            <div class="stat-item"><span class="label">Railway Companies</span><span class="value" id="statRailways">-</span></div>
            <div class="stat-item"><span class="label">Settlements</span><span class="value" id="statSettlements">-</span></div>
            <div class="stat-item"><span class="label">Connections</span><span class="value" id="statConnections">-</span></div>

            <h3 style="margin-top: 15px;">Controls</h3>
            <button class="control-btn" onclick="togglePhysics()">Toggle Physics</button>
            <button class="control-btn" onclick="resetView()">Reset View</button>
            <button class="control-btn" onclick="showSettlementsOnly()">Show Settlements Only</button>
            <button class="control-btn" onclick="showAll()">Show All</button>

            <div class="details-panel">
                <h3>Selection</h3>
                <div class="details-content" id="details">Click a node to see details. Drag railway companies to reposition.</div>
            </div>

            <div class="instructions">
                <strong>How it works:</strong> Years are fixed along the top as a timeline from 1882 to 1923.
                Each diamond represents a settlement being reached by a railway in a given year.
                Railway company circles are pulled toward the years when they were most actively building,
                revealing the temporal patterns of Saskatchewan's railway expansion.
                <br><br>
                <strong>CPR</strong> dominates the early 1880s, <strong>CNoR</strong> surges in 1905-1914,
                <strong>GTPR</strong> builds through 1907-1914, and <strong>QLSRSC</strong> connects
                Regina to Prince Albert in 1887-1890.
            </div>
        </div>
    </div>

    <script>
    async function init() {
        const response = await fetch('data/railway_timeline.json');
        const data = await response.json();

        const railwayColors = {
            CPR: '#c75d38',
            QLSRSC: '#0b6a41',
            CNoR: '#f1c730',
            GTPR: '#6c5ce7',
            Other: '#9A9B9D'
        };

        // Collect all unique years
        const allYears = new Set();
        const railwayNames = Object.keys(data);
        railwayNames.forEach(rw => {
            data[rw].forEach(s => allYears.add(s.year));
        });
        const sortedYears = [...allYears].sort((a, b) => a - b);
        const minYear = sortedYears[0];
        const maxYear = sortedYears[sortedYears.length - 1];

        // Build year position map (x coordinate for each year)
        const YEAR_SPACING = 120;
        const yearX = {};
        sortedYears.forEach((y, i) => {
            yearX[y] = i * YEAR_SPACING;
        });

        const networkNodes = [];
        const networkEdges = [];
        let edgeId = 0;

        // 1. Year nodes (fixed along top)
        sortedYears.forEach(y => {
            networkNodes.push({
                id: 'year_' + y,
                label: String(y),
                nodeType: 'year',
                shape: 'box',
                x: yearX[y],
                y: 0,
                fixed: { x: true, y: true },
                color: { background: '#2d3748', border: '#4a5568' },
                font: { color: '#e2e8f0', size: 14, face: 'monospace' },
                size: 25,
                mass: 1
            });
        });

        // 2. Barrier nodes (invisible wall to keep railway nodes below year line)
        const barrierSpacing = 60;
        const maxX = (sortedYears.length - 1) * YEAR_SPACING + 120;
        for (let bx = 0; bx <= maxX; bx += barrierSpacing) {
            networkNodes.push({
                id: 'barrier_' + bx,
                label: '',
                nodeType: 'barrier',
                shape: 'dot',
                size: 1,
                x: bx,
                y: 80,
                fixed: { x: true, y: true },
                color: { background: 'transparent', border: 'transparent' },
                mass: 3
            });
        }

        // 3. Settlement nodes (diamonds, one per settlement-railway-year entry)
        let settlementCount = 0;
        const railwaySettlementIds = {}; // railway -> [settlement node ids]

        railwayNames.forEach(rw => {
            railwaySettlementIds[rw] = [];
            data[rw].forEach((s, idx) => {
                const nodeId = 'settlement_' + rw + '_' + idx;
                settlementCount++;
                railwaySettlementIds[rw].push(nodeId);

                networkNodes.push({
                    id: nodeId,
                    label: '',
                    nodeType: 'settlement',
                    shape: 'diamond',
                    size: 8,
                    x: yearX[s.year],
                    y: 150,
                    mass: 0.5,
                    color: { background: railwayColors[rw], border: railwayColors[rw] },
                    title: s.name + ' (' + s.year + ')\nRailway: ' + rw,
                    settlementName: s.name,
                    railway: rw,
                    year: s.year
                });

                // Edge: settlement -> year (temporal anchor, white)
                networkEdges.push({
                    id: 'e' + (edgeId++),
                    from: nodeId,
                    to: 'year_' + s.year,
                    color: { color: '#ffffff', opacity: 0.15 },
                    width: 0.5,
                    smooth: { type: 'continuous' }
                });
            });
        });

        // 4. Railway company nodes (circles, pulled toward their active years)
        const railwayLabels = {
            CPR: 'CPR',
            QLSRSC: 'QLSRSC',
            CNoR: 'CNoR',
            GTPR: 'GTPR',
            Other: 'Other'
        };

        railwayNames.forEach(rw => {
            const settlements = data[rw];
            const count = settlements.length;

            // Weighted average x position based on settlement years
            const avgX = settlements.reduce((sum, s) => sum + yearX[s.year], 0) / count;

            // Determine year range for tooltip
            const years = settlements.map(s => s.year);
            const yrMin = Math.min(...years);
            const yrMax = Math.max(...years);

            // Size based on settlement count
            let nodeSize;
            if (count > 80) nodeSize = 60;
            else if (count > 40) nodeSize = 50;
            else if (count > 15) nodeSize = 40;
            else if (count > 5) nodeSize = 30;
            else nodeSize = 22;

            const nodeId = 'railway_' + rw;

            networkNodes.push({
                id: nodeId,
                label: railwayLabels[rw],
                nodeType: 'railway',
                shape: 'dot',
                size: nodeSize,
                x: avgX,
                y: 350,
                mass: 2,
                color: { background: railwayColors[rw], border: railwayColors[rw] },
                font: { color: '#ffffff', size: 12, strokeWidth: 2, strokeColor: '#000000' },
                title: railwayLabels[rw] + ' | ' + count + ' settlements | Years: ' + yrMin + '-' + yrMax,
                settlementCount: count,
                yearRange: yrMin + '-' + yrMax
            });

            // Edges: railway -> settlement (colored by railway)
            railwaySettlementIds[rw].forEach(sId => {
                networkEdges.push({
                    id: 'e' + (edgeId++),
                    from: nodeId,
                    to: sId,
                    color: { color: railwayColors[rw], opacity: 0.3 },
                    width: 1,
                    arrows: { to: { enabled: true, scaleFactor: 0.3 } },
                    smooth: { type: 'curvedCW', roundness: 0.1 }
                });
            });
        });

        // Update stats
        document.getElementById('statYears').textContent = minYear + '-' + maxYear;
        document.getElementById('statRailways').textContent = railwayNames.length;
        document.getElementById('statSettlements').textContent = settlementCount;
        document.getElementById('statConnections').textContent = networkEdges.length;

        // Create vis.js network
        const nodes = new vis.DataSet(networkNodes);
        const edges = new vis.DataSet(networkEdges);

        let physicsEnabled = true;

        const network = new vis.Network(document.getElementById('network'), { nodes, edges }, {
            nodes: {
                font: { color: '#ffffff', size: 11 },
                borderWidth: 2
            },
            edges: {
                smooth: { type: 'continuous' }
            },
            physics: {
                enabled: true,
                stabilization: { iterations: 500, fit: true },
                barnesHut: {
                    gravitationalConstant: -4000,
                    centralGravity: 0.05,
                    springLength: 150,
                    springConstant: 0.03,
                    damping: 0.4,
                    avoidOverlap: 0.5
                }
            },
            interaction: {
                hover: true,
                tooltipDelay: 100,
                navigationButtons: true,
                keyboard: true,
                dragNodes: true
            }
        });

        // Custom force: push railway nodes away from year line
        const MIN_RAILWAY_Y = 200;
        const PUSH_STRENGTH = 0.5;

        network.on('beforeDrawing', function(ctx) {
            nodes.forEach(function(node) {
                if (node.nodeType === 'railway') {
                    const pos = network.getPosition(node.id);
                    if (pos.y < MIN_RAILWAY_Y) {
                        const newY = pos.y + (MIN_RAILWAY_Y - pos.y) * PUSH_STRENGTH;
                        network.moveNode(node.id, pos.x, newY);
                    }
                }
            });
        });

        // After stabilization, reduce physics for subtle floating
        network.on('stabilizationIterationsDone', function() {
            document.getElementById('loading').style.display = 'none';
            network.setOptions({
                physics: {
                    barnesHut: {
                        gravitationalConstant: -2000,
                        springConstant: 0.01,
                        damping: 0.5
                    }
                }
            });
        });

        // Click handler for selection details
        network.on('click', function(params) {
            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                const node = nodes.get(nodeId);
                if (node) {
                    let html = '<strong>' + (node.label || node.settlementName || nodeId) + '</strong><br>';
                    html += '<span style="color:#888">Type: ' + node.nodeType + '</span><br>';
                    if (node.nodeType === 'settlement') {
                        html += 'Settlement: ' + node.settlementName + '<br>';
                        html += 'Railway: ' + node.railway + '<br>';
                        html += 'Year: ' + node.year;
                    } else if (node.nodeType === 'railway') {
                        html += 'Settlements: ' + node.settlementCount + '<br>';
                        html += 'Active years: ' + node.yearRange;
                    } else if (node.nodeType === 'year') {
                        // Count settlements for this year
                        const yearNum = parseInt(node.label);
                        let yearCount = 0;
                        railwayNames.forEach(rw => {
                            data[rw].forEach(s => {
                                if (s.year === yearNum) yearCount++;
                            });
                        });
                        html += 'Settlements reached: ' + yearCount;
                    }
                    document.getElementById('details').innerHTML = html;
                }
            }
        });

        // Expose functions globally
        window.togglePhysics = function() {
            physicsEnabled = !physicsEnabled;
            network.setOptions({ physics: { enabled: physicsEnabled } });
        };

        window.resetView = function() {
            network.fit();
        };

        window.showSettlementsOnly = function() {
            const updates = [];
            nodes.forEach(n => {
                if (n.nodeType === 'railway') {
                    updates.push({ id: n.id, hidden: true });
                }
            });
            nodes.update(updates);
        };

        window.showAll = function() {
            const updates = [];
            nodes.forEach(n => {
                updates.push({ id: n.id, hidden: false });
            });
            nodes.update(updates);
        };
    }

    init();
    </script>
</body>
</html>

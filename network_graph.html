<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway Network Graph</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000000;
            color: #eee;
        }
        .header {
            background: #1a1a1e;
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #0b6a41;
        }
        .header h1 {
            color: #ffffff;
            margin-bottom: 10px;
        }
        .header p {
            color: #9A9B9D;
            max-width: 800px;
            margin: 0 auto;
        }
        .nav {
            background: #252528;
            padding: 10px;
            text-align: center;
            position: relative;
        }
        .nav-dropdown {
            position: relative;
            display: inline-block;
        }
        .nav-btn {
            color: #f1c730;
            background: transparent;
            border: 1px solid #f1c730;
            padding: 8px 20px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .nav-btn:hover {
            background: #f1c730;
            color: #000;
        }
        .nav-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #252528;
            border: 1px solid #f1c730;
            border-radius: 5px;
            padding: 10px 0;
            min-width: 200px;
            z-index: 1000;
            margin-top: 5px;
        }
        .nav-menu.show {
            display: block;
        }
        .nav-menu a {
            display: block;
            color: #f1c730;
            text-decoration: none;
            padding: 8px 20px;
            transition: all 0.2s;
        }
        .nav-menu a:hover {
            background: #0b6a41;
            color: #fff;
        }
        .nav-menu a.current {
            color: #0b6a41;
            font-weight: bold;
        }
        .container {
            display: flex;
            height: calc(100vh - 160px);
        }
        .view-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: opacity 0.5s;
        }
        #graph {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        #graph.active {
            opacity: 1;
            pointer-events: auto;
        }
        #map.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .sidebar {
            width: 280px;
            background: #1a1a1e;
            padding: 15px;
            overflow-y: auto;
        }
        .view-toggle {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }
        .view-toggle button {
            flex: 1;
            padding: 8px;
            border: 2px solid #0b6a41;
            background: transparent;
            color: #0b6a41;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
        }
        .view-toggle button.active {
            background: #0b6a41;
            color: #fff;
        }
        .view-toggle button:hover:not(.active) {
            background: rgba(11, 106, 65, 0.2);
        }
        .controls {
            margin-bottom: 10px;
        }
        .year-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .year-row label {
            color: #f1c730;
            font-size: 13px;
            font-weight: bold;
        }
        .year-row input[type="range"] {
            flex: 1;
            margin: 0;
        }
        .year-display {
            font-size: 16px;
            font-weight: bold;
            color: #f1c730;
            min-width: 35px;
        }
        input[type="range"] {
            width: 100%;
            margin: 10px 0;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: #4D4E53;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            height: 6px;
            background: transparent;
            border-radius: 3px;
        }
        input[type="range"]::-moz-range-track {
            height: 6px;
            background: #4D4E53;
            border-radius: 3px;
        }
        input[type="range"]::-moz-range-progress {
            height: 6px;
            background: #f1c730;
            border-radius: 3px 0 0 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #ffffff;
            border-radius: 50%;
            margin-top: -5px;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #ffffff;
            border-radius: 50%;
            border: none;
            cursor: pointer;
        }
        .play-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .play-controls button {
            background: #0b6a41;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
        }
        .play-controls button:hover {
            background: #0d8550;
        }
        .section {
            background: #252528;
            padding: 10px 12px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .section h3 {
            color: #f1c730;
            margin-bottom: 8px;
            border-bottom: 1px solid #0b6a41;
            padding-bottom: 5px;
            font-size: 13px;
        }
        .railway-toggles {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }
        .railway-toggle {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            transition: background 0.2s;
        }
        .railway-toggle:hover {
            background: #000000;
        }
        .railway-toggle.inactive {
            opacity: 0.4;
        }
        .railway-toggle input {
            margin-right: 6px;
            accent-color: #0b6a41;
        }
        .railway-color {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            margin-right: 5px;
        }
        .railway-toggle span {
            font-size: 11px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .stat-box {
            background: #000000;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-box .value {
            font-size: 20px;
            font-weight: bold;
            color: #f1c730;
        }
        .stat-box .label {
            font-size: 10px;
            color: #888;
            margin-top: 2px;
        }
        .top-hubs {
            list-style: none;
        }
        .top-hubs li {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #000000;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .top-hubs li:hover {
            background: #000000;
            margin: 0 -4px;
            padding: 4px;
            border-radius: 3px;
        }
        .top-hubs .name {
            color: #ccc;
        }
        .top-hubs .degree {
            color: #f1c730;
            font-weight: bold;
        }
        .legend {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid #000000;
        }
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 10px;
            color: #888;
            margin: 4px 0;
        }
        .legend-line {
            width: 16px;
            height: 3px;
            margin-right: 6px;
            border-radius: 2px;
        }
        .legend-circle {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .legend-diamond {
            width: 8px;
            height: 8px;
            transform: rotate(45deg);
            margin-right: 6px;
        }
        .network-explanation {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(26, 26, 30, 0.9);
            border: 1px solid #0b6a41;
            border-radius: 5px;
            padding: 10px 14px;
            max-width: 360px;
            font-size: 11px;
            line-height: 1.5;
            color: #9A9B9D;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
            z-index: 500;
        }
        .network-explanation strong {
            color: #f1c730;
        }
        .network-explanation.visible {
            opacity: 1;
        }
        /* D3 Graph styles */
        .node {
            cursor: pointer;
            transition: r 0.3s;
        }
        .node:hover {
            stroke: #fff;
            stroke-width: 2px;
        }
        .node-diamond {
            cursor: pointer;
        }
        .node-diamond:hover {
            stroke: #fff;
            stroke-width: 2px;
        }
        .link {
            stroke-opacity: 0.6;
            transition: stroke-opacity 0.3s;
        }
        .tooltip {
            position: absolute;
            background: #1a1a1e;
            border: 1px solid #f1c730;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
        }
        /* Leaflet marker styles */
        .diamond-marker {
            background: transparent !important;
            border: none !important;
        }
        .diamond {
            width: 8px;
            height: 8px;
            transform: rotate(45deg);
            border: 2px solid #888;
            transition: all 0.2s;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Railway Network Graph</h1>
        <p>Interactive network graph showing all 429 Saskatchewan settlements as nodes<br>and railway connections as edges. Toggle between Geographic and Network views.</p>
    </div>
    <div class="nav">
        <div class="nav-dropdown">
            <button class="nav-btn" id="navBtn">Other Visualizations ▼</button>
            <div class="nav-menu" id="navMenu">
                <a href="index.html">Home</a>
                <a href="one_hour_map.html">Saskatoon Corridor</a>
                <a href="settlement_explorer.html">Settlement Explorer</a>
                <a href="railway_timeline.html">Railway Timeline</a>
                <a href="network_graph.html" class="current">Network Graph</a>
                <a href="isochrone.html">Travel Comparison</a>
                <a href="journey_times.html">Journey Times</a>
                <a href="travel_race.html">Time Simulation</a>
                <a href="transport_eras.html">Transport Eras</a>
                <a href="railway_temporal_network.html">Temporal Network</a>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="view-container">
            <div id="map"></div>
            <svg id="graph"></svg>
            <div class="network-explanation" id="networkExplanation">
                <strong>Network Topology View</strong><br>
                Geography is removed. Settlements are arranged by connectivity alone — linked settlements pull together, forming clusters. Larger nodes are major hubs with many connections. This reveals the structure of the railway network: tightly connected corridors, peripheral endpoints, and central junctions.
            </div>
        </div>
        <div class="sidebar">
            <div class="view-toggle">
                <button id="geoBtn" class="active">Geographic</button>
                <button id="forceBtn">Network</button>
            </div>

            <div class="controls">
                <div class="year-row">
                    <label>Year:</label>
                    <span class="year-display" id="yearDisplay">1882</span>
                    <input type="range" id="yearSlider" min="1882" max="1920" step="1" value="1882">
                </div>
                <div class="play-controls">
                    <button id="playBtn">Play</button>
                    <button id="resetBtn">Reset</button>
                </div>
            </div>

            <div class="section">
                <h3>RAILWAYS</h3>
                <div class="railway-toggles">
                    <label class="railway-toggle" data-railway="CPR">
                        <input type="checkbox" checked>
                        <div class="railway-color" style="background: #c75d38;"></div>
                        <span>CPR</span>
                    </label>
                    <label class="railway-toggle" data-railway="QLSRSC">
                        <input type="checkbox" checked>
                        <div class="railway-color" style="background: #0b6a41;"></div>
                        <span>QLSRSC</span>
                    </label>
                    <label class="railway-toggle" data-railway="CNoR">
                        <input type="checkbox" checked>
                        <div class="railway-color" style="background: #f1c730;"></div>
                        <span>CNoR</span>
                    </label>
                    <label class="railway-toggle" data-railway="GTPR">
                        <input type="checkbox" checked>
                        <div class="railway-color" style="background: #6c5ce7;"></div>
                        <span>GTPR</span>
                    </label>
                    <label class="railway-toggle" data-railway="Other">
                        <input type="checkbox" checked>
                        <div class="railway-color" style="background: #888;"></div>
                        <span>Other</span>
                    </label>
                    <label class="railway-toggle" data-railway="Interchange">
                        <input type="checkbox" checked>
                        <div class="railway-color" style="background: #ffffff; border: 1px dashed #888;"></div>
                        <span>Interchange</span>
                    </label>
                </div>
            </div>

            <div class="section">
                <h3>NETWORK STATS</h3>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="value" id="edgeCount">0</div>
                        <div class="label">Edges</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="densityValue">0%</div>
                        <div class="label">Density</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="connectedCount">0</div>
                        <div class="label">Connected</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="isolatedCount">0</div>
                        <div class="label">Isolated</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>TOP HUBS</h3>
                <ol class="top-hubs" id="topHubs">
                    <li><span class="name">Loading...</span></li>
                </ol>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-circle" style="background: #c75d38;"></div>
                    <span>CPR settlement</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle" style="background: #0b6a41;"></div>
                    <span>QLSRSC settlement</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle" style="background: #f1c730;"></div>
                    <span>CNoR settlement</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle" style="background: #6c5ce7;"></div>
                    <span>GTPR settlement</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line" style="background: transparent; border-top: 2px dashed #ffffff;"></div>
                    <span>Interchange (cross-railway)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-diamond" style="background: #c75d38;"></div>
                    <span>Multi-railway junction</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle" style="background: #666;"></div>
                    <span>Isolated (no railway yet)</span>
                </div>
            </div>
        </div>
    </div>
    <div class="tooltip" id="tooltip"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Nav dropdown toggle
        document.getElementById('navBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('navMenu').classList.toggle('show');
        });
        document.addEventListener('click', function() {
            document.getElementById('navMenu').classList.remove('show');
        });

        // Railway colors
        const railwayColors = {
            CPR: '#c75d38',
            QLSRSC: '#0b6a41',
            CNoR: '#f1c730',
            GTPR: '#6c5ce7',
            Interchange: '#ffffff',
            Other: '#888'
        };

        // State
        let data = null;
        let currentView = 'geo';  // 'geo' or 'force'
        let visibleRailways = {CPR: true, QLSRSC: true, CNoR: true, GTPR: true, Interchange: true, Other: true};
        let isPlaying = false;
        let playInterval = null;
        let nodeDegrees = {};

        // Leaflet state
        let map = null;
        let leafletMarkers = {};
        let leafletEdges = [];

        // D3 state
        let svg, d3Nodes = [], d3Links = [];
        let nodeElements, linkElements;
        let graphWidth, graphHeight;

        // ==================== INITIALIZATION ====================

        function init() {
            initLeaflet();
            initD3();
            loadData();
            setupEventListeners();
        }

        function initLeaflet() {
            map = L.map('map', {
                center: [52.0, -106.0],
                zoom: 6
            });

            // Use CartoDB Voyager (lighter, more muted than dark theme)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
        }

        function initD3() {
            svg = d3.select('#graph');
            const container = document.querySelector('.view-container');
            graphWidth = container.clientWidth;
            graphHeight = container.clientHeight;
            svg.attr('width', graphWidth).attr('height', graphHeight);

            // Add zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([0.3, 4])
                .on('zoom', (event) => {
                    svg.select('g').attr('transform', event.transform);
                });
            svg.call(zoom);

            // Create main group
            svg.append('g');
        }

        // ==================== DATA LOADING ====================

        async function loadData() {
            try {
                const response = await fetch('data/settlement_connections.json');
                data = await response.json();
                console.log('Data loaded:', Object.keys(data.settlements).length, 'settlements');

                processDataForD3();
                createLeafletMarkers();
                createD3Elements();
                updateVisualization();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('topHubs').innerHTML = '<li>Error loading data. Try: python -m http.server 8080</li>';
            }
        }

        function getFirstRailway(settlement) {
            if (!settlement.railways || settlement.railways.length === 0) {
                return 'Other';
            }
            let railway = settlement.first_railway;
            if (!['CPR', 'QLSRSC', 'CNoR', 'GTPR'].includes(railway)) {
                return 'Other';
            }
            return railway;
        }

        function isMultiRailway(settlement) {
            return settlement.railways && settlement.railways.length > 1;
        }

        function processDataForD3() {
            // Build nodes array
            d3Nodes = Object.entries(data.settlements).map(([name, s]) => ({
                id: name,
                lat: s.lat,
                lon: s.lon,
                railway_arrives: s.railway_arrives,
                first_railway: getFirstRailway(s),
                isMultiRailway: isMultiRailway(s),
                railways: s.railways,
                geoX: 0,
                geoY: 0,
                forceX: 0,
                forceY: 0
            }));

            // Calculate geographic positions for D3 view
            const lats = d3Nodes.map(n => n.lat);
            const lons = d3Nodes.map(n => n.lon);
            const latExtent = [Math.min(...lats), Math.max(...lats)];
            const lonExtent = [Math.min(...lons), Math.max(...lons)];
            const padding = 60;

            d3Nodes.forEach(node => {
                node.geoX = padding + ((node.lon - lonExtent[0]) / (lonExtent[1] - lonExtent[0])) * (graphWidth - padding * 2);
                node.geoY = padding + ((latExtent[1] - node.lat) / (latExtent[1] - latExtent[0])) * (graphHeight - padding * 2);
            });

            // Build links array (unique edges)
            const linkSet = new Set();
            d3Links = [];
            Object.entries(data.connections).forEach(([from, connections]) => {
                connections.forEach(conn => {
                    if (!conn.connected_year) return;
                    const key = [from, conn.to].sort().join('|');
                    if (linkSet.has(key)) return;
                    linkSet.add(key);

                    let railway = conn.shared_railway;
                    if (!['CPR', 'QLSRSC', 'CNoR', 'GTPR', 'Interchange'].includes(railway)) {
                        railway = 'Other';
                    }

                    d3Links.push({
                        source: from,
                        target: conn.to,
                        railway: railway,
                        connected_year: conn.connected_year,
                        isInterchange: conn.connection_type === 'interchange'
                    });
                });
            });

            // Run force simulation to get force-directed positions
            const simulation = d3.forceSimulation(d3Nodes)
                .force('link', d3.forceLink(d3Links).id(d => d.id).distance(25).strength(0.5))
                .force('charge', d3.forceManyBody().strength(-40))
                .force('center', d3.forceCenter(graphWidth / 2, graphHeight / 2))
                .force('collision', d3.forceCollide().radius(6))
                .stop();

            // Run simulation iterations
            for (let i = 0; i < 300; i++) simulation.tick();

            // Store force positions
            d3Nodes.forEach(node => {
                node.forceX = node.x;
                node.forceY = node.y;
            });

            console.log(`Processed ${d3Nodes.length} nodes, ${d3Links.length} links`);
        }

        // ==================== LEAFLET MARKERS ====================

        function createLeafletMarkers() {
            // Create edges first (so they're behind nodes)
            d3Links.forEach(link => {
                const source = data.settlements[link.source.id || link.source];
                const target = data.settlements[link.target.id || link.target];
                if (!source || !target) return;

                const polyline = L.polyline(
                    [[source.lat, source.lon], [target.lat, target.lon]],
                    {
                        color: railwayColors[link.railway],
                        weight: link.isInterchange ? 1.5 : 2,
                        opacity: 0,
                        dashArray: link.isInterchange ? '4,3' : null
                    }
                ).addTo(map);

                polyline.linkData = link;
                leafletEdges.push(polyline);
            });

            // Create node markers
            Object.entries(data.settlements).forEach(([name, settlement]) => {
                const firstRailway = getFirstRailway(settlement);
                const multiRailway = isMultiRailway(settlement);
                const color = railwayColors[firstRailway] || '#666';
                let marker;

                if (multiRailway) {
                    // Diamond marker for multi-railway junctions
                    const diamondIcon = L.divIcon({
                        className: 'diamond-marker',
                        html: `<div class="diamond" style="background: ${color}; border-color: #fff;" data-name="${name}"></div>`,
                        iconSize: [12, 12],
                        iconAnchor: [6, 6]
                    });
                    marker = L.marker([settlement.lat, settlement.lon], {icon: diamondIcon}).addTo(map);
                } else {
                    marker = L.circleMarker([settlement.lat, settlement.lon], {
                        radius: 4,
                        fillColor: color,
                        color: '#fff',
                        weight: 1,
                        opacity: 0.8,
                        fillOpacity: 0.6
                    }).addTo(map);
                }

                marker.bindTooltip(name, {
                    permanent: false,
                    direction: 'top',
                    offset: [0, -5]
                });

                marker.settlementData = {
                    name,
                    firstRailway,
                    multiRailway,
                    railway_arrives: settlement.railway_arrives
                };

                leafletMarkers[name] = marker;
                nodeDegrees[name] = 0;
            });
        }

        // ==================== D3 ELEMENTS ====================

        function createD3Elements() {
            const g = svg.select('g');

            // Create links
            linkElements = g.selectAll('.link')
                .data(d3Links)
                .enter()
                .append('line')
                .attr('class', 'link')
                .attr('stroke', d => railwayColors[d.railway])
                .attr('stroke-width', d => d.isInterchange ? 1.5 : 2)
                .attr('stroke-dasharray', d => d.isInterchange ? '4,3' : null)
                .attr('x1', d => d.source.geoX)
                .attr('y1', d => d.source.geoY)
                .attr('x2', d => d.target.geoX)
                .attr('y2', d => d.target.geoY);

            // Create circle nodes
            const circleNodes = d3Nodes.filter(d => !d.isMultiRailway);
            nodeElements = g.selectAll('.node')
                .data(circleNodes)
                .enter()
                .append('circle')
                .attr('class', 'node')
                .attr('r', 4)
                .attr('cx', d => d.geoX)
                .attr('cy', d => d.geoY)
                .attr('fill', d => railwayColors[d.first_railway] || '#666')
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip);

            // Create diamond nodes for multi-railway
            const diamondNodes = d3Nodes.filter(d => d.isMultiRailway);
            g.selectAll('.node-diamond')
                .data(diamondNodes)
                .enter()
                .append('rect')
                .attr('class', 'node-diamond')
                .attr('width', 10)
                .attr('height', 10)
                .attr('x', d => d.geoX - 5)
                .attr('y', d => d.geoY - 5)
                .attr('transform', d => `rotate(45, ${d.geoX}, ${d.geoY})`)
                .attr('fill', d => railwayColors[d.first_railway] || '#666')
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip);

        }

        // ==================== VIEW SWITCHING ====================

        function switchView(view) {
            if (view === currentView) return;
            currentView = view;

            document.getElementById('geoBtn').classList.toggle('active', view === 'geo');
            document.getElementById('forceBtn').classList.toggle('active', view === 'force');
            document.getElementById('map').classList.toggle('hidden', view === 'force');
            document.getElementById('graph').classList.toggle('active', view === 'force');
            document.getElementById('networkExplanation').classList.toggle('visible', view === 'force');

            if (view === 'force') {
                animateToForce();
            }
        }

        function animateToForce() {
            const duration = 800;

            // Animate circle nodes
            svg.selectAll('.node')
                .transition()
                .duration(duration)
                .attr('cx', d => d.forceX)
                .attr('cy', d => d.forceY);

            // Animate diamond nodes
            svg.selectAll('.node-diamond')
                .transition()
                .duration(duration)
                .attr('x', d => d.forceX - 5)
                .attr('y', d => d.forceY - 5)
                .attr('transform', d => `rotate(45, ${d.forceX}, ${d.forceY})`);

            // Animate links
            linkElements
                .transition()
                .duration(duration)
                .attr('x1', d => d.source.forceX)
                .attr('y1', d => d.source.forceY)
                .attr('x2', d => d.target.forceX)
                .attr('y2', d => d.target.forceY);

        }

        // ==================== VISUALIZATION UPDATE ====================

        function updateSliderTrack(slider) {
            const min = parseInt(slider.min);
            const max = parseInt(slider.max);
            const val = parseInt(slider.value);
            const percent = ((val - min) / (max - min)) * 100;
            slider.style.background = `linear-gradient(to right, #f1c730 0%, #f1c730 ${percent}%, #4D4E53 ${percent}%, #4D4E53 100%)`;
        }

        function updateVisualization() {
            const slider = document.getElementById('yearSlider');
            const year = parseInt(slider.value);
            document.getElementById('yearDisplay').textContent = year;
            updateSliderTrack(slider);

            // Reset degrees
            Object.keys(nodeDegrees).forEach(name => nodeDegrees[name] = 0);

            let visibleEdgeCount = 0;
            let connectedCount = 0;
            let isolatedCount = 0;

            // Update Leaflet edges
            leafletEdges.forEach(polyline => {
                const link = polyline.linkData;
                const isVisible = link.connected_year <= year && visibleRailways[link.railway];
                polyline.setStyle({ opacity: isVisible ? (link.isInterchange ? 0.3 : 0.6) : 0 });

                if (isVisible) {
                    visibleEdgeCount++;
                    const sourceId = link.source.id || link.source;
                    const targetId = link.target.id || link.target;
                    nodeDegrees[sourceId]++;
                    nodeDegrees[targetId]++;
                }
            });

            // Update D3 links
            linkElements.attr('stroke-opacity', d => {
                const isVisible = d.connected_year <= year && visibleRailways[d.railway];
                return isVisible ? (d.isInterchange ? 0.3 : 0.6) : 0;
            });

            // Update Leaflet markers
            Object.entries(leafletMarkers).forEach(([name, marker]) => {
                const degree = nodeDegrees[name];
                const sData = marker.settlementData;
                const hasRailway = sData.railway_arrives && sData.railway_arrives <= year;
                const color = railwayColors[sData.firstRailway] || '#666';

                if (sData.multiRailway) {
                    const diamond = document.querySelector(`.diamond[data-name="${name}"]`);
                    if (diamond) {
                        if (degree > 0) {
                            connectedCount++;
                            const size = Math.min(8 + degree * 0.6, 14);
                            diamond.style.width = size + 'px';
                            diamond.style.height = size + 'px';
                            diamond.style.background = color;
                            diamond.style.borderColor = '#fff';
                            diamond.style.opacity = '1';
                        } else if (hasRailway) {
                            isolatedCount++;
                            diamond.style.width = '8px';
                            diamond.style.height = '8px';
                            diamond.style.background = '#888';
                            diamond.style.borderColor = '#aaa';
                            diamond.style.opacity = '0.6';
                        } else {
                            isolatedCount++;
                            diamond.style.width = '6px';
                            diamond.style.height = '6px';
                            diamond.style.background = '#444';
                            diamond.style.borderColor = '#666';
                            diamond.style.opacity = '0.4';
                        }
                    }
                } else {
                    if (degree > 0) {
                        connectedCount++;
                        const radius = Math.min(4 + degree * 0.8, 12);
                        marker.setStyle({
                            radius: radius,
                            fillColor: color,
                            color: '#fff',
                            weight: 1,
                            fillOpacity: 0.8
                        });
                    } else if (hasRailway) {
                        isolatedCount++;
                        marker.setStyle({
                            radius: 4,
                            fillColor: '#888',
                            color: '#aaa',
                            weight: 1,
                            fillOpacity: 0.6
                        });
                    } else {
                        isolatedCount++;
                        marker.setStyle({
                            radius: 3,
                            fillColor: '#444',
                            color: '#666',
                            weight: 1,
                            fillOpacity: 0.4
                        });
                    }
                }
            });

            // Update D3 nodes
            svg.selectAll('.node')
                .attr('r', d => {
                    const degree = nodeDegrees[d.id];
                    if (degree > 0) return Math.min(4 + degree * 0.5, 12);
                    if (d.railway_arrives && d.railway_arrives <= year) return 4;
                    return 3;
                })
                .attr('fill', d => {
                    const degree = nodeDegrees[d.id];
                    const hasRailway = d.railway_arrives && d.railway_arrives <= year;
                    if (degree > 0) return railwayColors[d.first_railway] || '#888';
                    if (hasRailway) return '#888';
                    return '#444';
                })
                .attr('opacity', d => {
                    const degree = nodeDegrees[d.id];
                    if (degree > 0) return 1;
                    if (d.railway_arrives && d.railway_arrives <= year) return 0.6;
                    return 0.3;
                });

            // Update D3 diamond nodes
            svg.selectAll('.node-diamond')
                .attr('width', d => {
                    const degree = nodeDegrees[d.id];
                    if (degree > 0) return Math.min(8 + degree * 0.4, 14);
                    return 8;
                })
                .attr('height', d => {
                    const degree = nodeDegrees[d.id];
                    if (degree > 0) return Math.min(8 + degree * 0.4, 14);
                    return 8;
                })
                .attr('fill', d => {
                    const degree = nodeDegrees[d.id];
                    const hasRailway = d.railway_arrives && d.railway_arrives <= year;
                    if (degree > 0) return railwayColors[d.first_railway] || '#888';
                    if (hasRailway) return '#888';
                    return '#444';
                })
                .attr('opacity', d => {
                    const degree = nodeDegrees[d.id];
                    if (degree > 0) return 1;
                    if (d.railway_arrives && d.railway_arrives <= year) return 0.6;
                    return 0.3;
                });

            // Update stats
            const totalNodes = Object.keys(leafletMarkers).length;
            const possibleEdges = (totalNodes * (totalNodes - 1)) / 2;
            const density = possibleEdges > 0 ? ((visibleEdgeCount / possibleEdges) * 100).toFixed(2) : 0;

            document.getElementById('edgeCount').textContent = visibleEdgeCount;
            document.getElementById('densityValue').textContent = density + '%';
            document.getElementById('connectedCount').textContent = connectedCount;
            document.getElementById('isolatedCount').textContent = isolatedCount;

            updateTopHubs();
        }

        function updateTopHubs() {
            const sorted = Object.entries(nodeDegrees)
                .filter(([name, degree]) => degree > 0)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const hubsHtml = sorted.map(([name, degree], i) =>
                `<li><span class="name">${i + 1}. ${name}</span><span class="degree">${degree}</span></li>`
            ).join('');

            document.getElementById('topHubs').innerHTML = hubsHtml || '<li><span class="name">No connected nodes</span></li>';
        }

        // ==================== TOOLTIPS ====================

        function showTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            const railways = d.railways ? d.railways.map(r => `${r.railway} (${r.year})`).join(', ') : 'None';
            tooltip.innerHTML = `<strong>${d.id}</strong><br>Railways: ${railways}<br>Connections: ${nodeDegrees[d.id] || 0}`;
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
            tooltip.style.opacity = 1;
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.opacity = 0;
        }

        // ==================== RAILWAY TOGGLES ====================

        function toggleRailway(railway) {
            visibleRailways[railway] = !visibleRailways[railway];
            const toggle = document.querySelector(`.railway-toggle[data-railway="${railway}"]`);
            toggle.classList.toggle('inactive', !visibleRailways[railway]);
            toggle.querySelector('input').checked = visibleRailways[railway];
            updateVisualization();
        }

        // ==================== ANIMATION ====================

        function togglePlay() {
            if (isPlaying) {
                clearInterval(playInterval);
                document.getElementById('playBtn').textContent = 'Play';
                isPlaying = false;
            } else {
                isPlaying = true;
                document.getElementById('playBtn').textContent = 'Pause';
                let year = parseInt(document.getElementById('yearSlider').value);

                playInterval = setInterval(() => {
                    year++;
                    if (year > 1920) {
                        clearInterval(playInterval);
                        document.getElementById('playBtn').textContent = 'Play';
                        isPlaying = false;
                        return;
                    }
                    document.getElementById('yearSlider').value = year;
                    updateVisualization();
                }, 500);
            }
        }

        function reset() {
            if (isPlaying) togglePlay();
            document.getElementById('yearSlider').value = 1882;
            updateVisualization();
        }

        // ==================== EVENT LISTENERS ====================

        function setupEventListeners() {
            document.getElementById('geoBtn').addEventListener('click', () => switchView('geo'));
            document.getElementById('forceBtn').addEventListener('click', () => switchView('force'));
            document.getElementById('yearSlider').addEventListener('input', updateVisualization);
            document.getElementById('playBtn').addEventListener('click', togglePlay);
            document.getElementById('resetBtn').addEventListener('click', reset);

            document.querySelectorAll('.railway-toggle').forEach(toggle => {
                toggle.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        e.preventDefault();
                    }
                    toggleRailway(toggle.dataset.railway);
                });
            });

            // Handle window resize
            window.addEventListener('resize', () => {
                const container = document.querySelector('.view-container');
                graphWidth = container.clientWidth;
                graphHeight = container.clientHeight;
                svg.attr('width', graphWidth).attr('height', graphHeight);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

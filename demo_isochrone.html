<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo: Isochrone Comparison</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
        }
        .header {
            background: #16213e;
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #e94560;
        }
        .header h1 { color: #e94560; margin-bottom: 10px; }
        .header p { color: #aaa; max-width: 800px; margin: 0 auto; }
        .container {
            display: flex;
            height: calc(100vh - 120px);
        }
        #map { flex: 1; }
        .sidebar {
            width: 320px;
            background: #16213e;
            padding: 20px;
            overflow-y: auto;
        }
        .control-group {
            background: #0f3460;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .control-group h3 {
            color: #e94560;
            margin-bottom: 10px;
            font-size: 14px;
        }
        select {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #0f3460;
            background: #1a1a2e;
            color: #eee;
            margin-bottom: 10px;
        }
        .time-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .time-btn {
            padding: 8px 16px;
            border: 2px solid #e94560;
            background: transparent;
            color: #e94560;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .time-btn.active {
            background: #e94560;
            color: white;
        }
        .mode-toggles {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .mode-toggle {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .mode-toggle:hover { background: #1a1a2e; }
        .mode-toggle input { margin-right: 10px; }
        .mode-toggle .color-box {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
        }
        .mode-toggle .details {
            font-size: 11px;
            color: #888;
        }
        .stats-box {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #0f3460;
            font-size: 13px;
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-value { color: #4ecca3; font-weight: bold; }
        .comparison {
            background: #0f3460;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .comparison h3 {
            color: #e94560;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .comparison-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .comparison-bar {
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 11px;
            color: white;
            font-weight: bold;
        }
        .explanation {
            background: #0f3460;
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
            line-height: 1.6;
            color: #aaa;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Demo: Isochrone Comparison</h1>
        <p>Compare how far you could travel in the same amount of time by different modes. Railways dramatically expanded the reachable world.</p>
    </div>
    <div class="container">
        <div id="map"></div>
        <div class="sidebar">
            <div class="control-group">
                <h3>CENTER POINT</h3>
                <select id="hubSelect"></select>
            </div>

            <div class="control-group">
                <h3>TRAVEL TIME</h3>
                <div class="time-selector">
                    <button class="time-btn" data-hours="0.5">30 min</button>
                    <button class="time-btn active" data-hours="1">1 hour</button>
                    <button class="time-btn" data-hours="2">2 hours</button>
                    <button class="time-btn" data-hours="4">4 hours</button>
                    <button class="time-btn" data-hours="8">8 hours</button>
                </div>
            </div>

            <div class="control-group">
                <h3>TRANSPORT MODES</h3>
                <div class="mode-toggles">
                    <label class="mode-toggle">
                        <input type="checkbox" id="showWalking" checked>
                        <div class="color-box" style="background: #888;"></div>
                        <div>
                            <div>Walking</div>
                            <div class="details">5 km/h</div>
                        </div>
                    </label>
                    <label class="mode-toggle">
                        <input type="checkbox" id="showWagon" checked>
                        <div class="color-box" style="background: #ffd93d;"></div>
                        <div>
                            <div>Horse & Wagon</div>
                            <div class="details">10 km/h</div>
                        </div>
                    </label>
                    <label class="mode-toggle">
                        <input type="checkbox" id="showRailway" checked>
                        <div class="color-box" style="background: #4ecca3;"></div>
                        <div>
                            <div>Railway</div>
                            <div class="details">40 km/h</div>
                        </div>
                    </label>
                </div>
            </div>

            <div class="comparison">
                <h3>DISTANCE IN <span id="timeLabel">1 HOUR</span></h3>
                <div class="comparison-item">
                    <div class="comparison-bar" id="walkBar" style="background: #888;"></div>
                    <span>Walking</span>
                </div>
                <div class="comparison-item">
                    <div class="comparison-bar" id="wagonBar" style="background: #ffd93d; color: #333;"></div>
                    <span>Wagon</span>
                </div>
                <div class="comparison-item">
                    <div class="comparison-bar" id="railBar" style="background: #4ecca3; color: #333;"></div>
                    <span>Railway</span>
                </div>
            </div>

            <div class="stats-box">
                <div class="stat-row">
                    <span>Settlements in walking range:</span>
                    <span class="stat-value" id="walkCount">0</span>
                </div>
                <div class="stat-row">
                    <span>Settlements in wagon range:</span>
                    <span class="stat-value" id="wagonCount">0</span>
                </div>
                <div class="stat-row">
                    <span>Settlements in railway range:</span>
                    <span class="stat-value" id="railCount">0</span>
                </div>
                <div class="stat-row">
                    <span>Railway expansion factor:</span>
                    <span class="stat-value" id="expansionFactor">-</span>
                </div>
            </div>

            <div class="explanation">
                <strong>The circles show how far you could travel in the same time.</strong><br><br>
                Before railways, most travel was by foot (5 km/h) or horse-drawn wagon (10 km/h). A one-hour journey meant 5-10 km.<br><br>
                Railways traveling at 40 km/h expanded your one-hour reach to 40 km - an <strong>8x increase</strong> over walking.
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let data = null;
        let map = null;
        let circles = { walking: null, wagon: null, railway: null };
        let markers = [];
        let hubMarker = null;
        let hubName = 'Saskatoon';
        let travelHours = 1;

        const speeds = {
            walking: 5,    // km/h
            wagon: 10,     // km/h
            railway: 40    // km/h
        };

        function initMap() {
            map = L.map('map').setView([52.0, -106.0], 7);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
        }

        async function loadData() {
            const response = await fetch('data/settlement_connections.json');
            data = await response.json();

            // Populate hub selector
            const hubSelect = document.getElementById('hubSelect');
            Object.keys(data.settlements).sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                if (name === 'Saskatoon') option.selected = true;
                hubSelect.appendChild(option);
            });

            updateVisualization();
        }

        function updateVisualization() {
            const hub = data.settlements[hubName];
            if (!hub) return;

            // Clear existing
            Object.values(circles).forEach(c => { if (c) map.removeLayer(c); });
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            if (hubMarker) map.removeLayer(hubMarker);

            // Calculate distances
            const walkDist = speeds.walking * travelHours;
            const wagonDist = speeds.wagon * travelHours;
            const railDist = speeds.railway * travelHours;

            // Update comparison bars
            const maxDist = railDist;
            document.getElementById('walkBar').style.width = (walkDist / maxDist * 150) + 'px';
            document.getElementById('walkBar').textContent = walkDist + ' km';
            document.getElementById('wagonBar').style.width = (wagonDist / maxDist * 150) + 'px';
            document.getElementById('wagonBar').textContent = wagonDist + ' km';
            document.getElementById('railBar').style.width = (railDist / maxDist * 150) + 'px';
            document.getElementById('railBar').textContent = railDist + ' km';
            document.getElementById('timeLabel').textContent =
                travelHours < 1 ? (travelHours * 60) + ' MINUTES' : travelHours + ' HOUR' + (travelHours > 1 ? 'S' : '');

            // Draw circles (largest first so smaller ones are on top)
            if (document.getElementById('showRailway').checked) {
                circles.railway = L.circle([hub.lat, hub.lon], {
                    radius: railDist * 1000,
                    color: '#4ecca3',
                    fillColor: '#4ecca3',
                    fillOpacity: 0.1,
                    weight: 3
                }).addTo(map);
            }

            if (document.getElementById('showWagon').checked) {
                circles.wagon = L.circle([hub.lat, hub.lon], {
                    radius: wagonDist * 1000,
                    color: '#ffd93d',
                    fillColor: '#ffd93d',
                    fillOpacity: 0.15,
                    weight: 3
                }).addTo(map);
            }

            if (document.getElementById('showWalking').checked) {
                circles.walking = L.circle([hub.lat, hub.lon], {
                    radius: walkDist * 1000,
                    color: '#888',
                    fillColor: '#888',
                    fillOpacity: 0.2,
                    weight: 3
                }).addTo(map);
            }

            // Add hub marker
            const hubIcon = L.divIcon({
                className: 'hub-marker',
                html: '<div style="background:#e94560; width:20px; height:20px; border-radius:50%; border:3px solid white;"></div>',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            hubMarker = L.marker([hub.lat, hub.lon], {icon: hubIcon}).addTo(map);
            hubMarker.bindPopup(`<b>${hubName}</b><br>Center point`);

            // Count settlements in each range
            let walkCount = 0, wagonCount = 0, railCount = 0;

            Object.entries(data.settlements).forEach(([name, s]) => {
                if (name === hubName) return;

                const dist = haversine(hub.lat, hub.lon, s.lat, s.lon);

                if (dist <= walkDist) walkCount++;
                if (dist <= wagonDist) wagonCount++;
                if (dist <= railDist) railCount++;

                // Add marker for settlements in railway range
                if (dist <= railDist) {
                    let color = '#666';
                    if (dist <= walkDist) color = '#888';
                    else if (dist <= wagonDist) color = '#ffd93d';
                    else color = '#4ecca3';

                    const marker = L.circleMarker([s.lat, s.lon], {
                        radius: 5,
                        fillColor: color,
                        color: '#fff',
                        weight: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    marker.bindPopup(`<b>${name}</b><br>Distance: ${dist.toFixed(1)} km`);
                    markers.push(marker);
                }
            });

            // Update stats
            document.getElementById('walkCount').textContent = walkCount;
            document.getElementById('wagonCount').textContent = wagonCount;
            document.getElementById('railCount').textContent = railCount;

            const expansion = walkCount > 0 ? (railCount / walkCount).toFixed(1) + 'x' : '-';
            document.getElementById('expansionFactor').textContent = expansion;

            // Center map
            map.setView([hub.lat, hub.lon], 8);
        }

        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // Event listeners
        document.getElementById('hubSelect').addEventListener('change', (e) => {
            hubName = e.target.value;
            updateVisualization();
        });

        document.querySelectorAll('.time-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                travelHours = parseFloat(btn.dataset.hours);
                updateVisualization();
            });
        });

        ['showWalking', 'showWagon', 'showRailway'].forEach(id => {
            document.getElementById(id).addEventListener('change', updateVisualization);
        });

        // Initialize
        initMap();
        loadData();
    </script>
</body>
</html>
